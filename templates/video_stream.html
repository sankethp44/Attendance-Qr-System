<!DOCTYPE html>
<html>
<head>
    <title>Video Stream</title>
    <style>
        /* Style for the popup overlay */
        #popupOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999; /* Set a high z-index to appear on top of other elements */
        }

        /* Style for the scanner popup */
        #scannerPopup {
            width: 640px;
            height: 480px;
            background-color: #fff;
            border: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Style for the video element */
        #video {
            width: 100%; /* Fit the video within the scannerPopup div */
            height: 100%; /* Fit the video within the scannerPopup div */
            object-fit: cover; /* Ensure the video covers the entire area */
        }
    </style>
    <script type="text/javascript" src="../jsQR-master/docs/jsQR.js"></script>
    <link rel="stylesheet" type="text/css" href="../static/Css/styles.css">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='Css/styles.css') }}">
</head>
<body>
    <div id="popupOverlay">
        <div id="scannerPopup">
            <video id="video" autoplay></video>
            <div class="button-container">
                <button class="my-button" onclick="closeScannerPopup()">Cancel</button>
                <button class="my-button" onclick="downloadRecords()">Download Records</button>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="../jsQR-master/docs/jsQR.js"></script>
    <script>
        // JavaScript code for opening the scanner and handling scanned data
        function openScanner() {
            // Check if the browser supports media devices (camera access)
            if ('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices) {
                // Access the camera and enable scanning
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(function (stream) {
                        // Create a video element to display the camera feed
                        const videoElement = document.getElementById('video');
                        videoElement.srcObject = stream;
                        videoElement.play();

                        // Create a new QR code scanner
                        const qrScanner = new QrScanner(videoElement, result => {
                            // Handle the scanned QR code data
                            handleScannedData(result);
                            qrScanner.stop();
                            videoElement.srcObject = null; // Stop the video stream
                            closeScannerPopup();
                        });

                        // Start the scanning process
                        qrScanner.start();
                    })
                    .catch(function (error) {
                        console.error('Error accessing camera:', error);
                    });
            } else {
                alert('Your browser does not support camera access. Please use a modern browser to access this feature.');
            }
        }

        // Function to close the scanner popup and return to HomePage.html
        function closeScannerPopup() {
            // Redirect back to the HomePage.html
            window.location.href = "{{ url_for('HomePage') }}";
        }

        function handleScannedData(result) {
            try {
                // Parse the JSON data from the scanned QR code
                const qrData = JSON.parse(result);

                // Send the scanned data to the Flask server using AJAX
                $.ajax({
                    type: "POST",
                    url: "/scanner",
                    data: JSON.stringify(qrData),
                    contentType: "application/json",
                    success: function (response) {
                        alert(response.message);
                    },
                    error: function (error) {
                        alert("Error processing QR code data: " + error.statusText);
                    }
                });
            } catch (error) {
                console.error("Error parsing QR code data:", error);
            }
        }

        // Call the openScanner function when the page is loaded
        document.addEventListener("DOMContentLoaded", function () {
            openScanner();
        });
        function downloadRecords() {
            // Redirect to the Flask route to download the records
            window.location.href = "{{ url_for('download_records') }}";
        }
    </script>
</body>
</html>
